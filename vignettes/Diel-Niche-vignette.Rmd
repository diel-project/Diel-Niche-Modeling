---
title: "Diel-Niche-vignette"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Diel-Niche-vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  %\VignetteDepends{bayesplot,ggplot2,coda,Diel.Niche}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introducion

The Diel.Niche package is used to evaluate how animals use the three fundamental periods of light: twilight (dawn & dusk), daytime, and nighttime. First, install and load the library

```{r package}
#Install package from simplified repo.
#Make sure to add your auth_token
#devtools::install_github("diel-project/Diel-Niche-Modeling"
#                         ,ref="Diel.Niche.Simplify"
#                         ,auth_token = "")

#Call the library
library(Diel.Niche)
```

Diel.Niche specifies many diel hypotheses, which together are defined into five hypothesis sets. The code names for the hypotheses and sets are,

```{r hyp}
what.hyp()
```

A short description of each hypothesis is available by calling,

```{r hyp2}
  what.hyp("D")
```

To list the hypotheses of a given set,

```{r hyp3}
  hyp.sets("Traditional")

  hyp.sets("Threshold")
```

The best way to understand each hypothesis set is by plotting all hypotheses. 

**Maximizing**

This hypothesis set is most useful if you are only interested in evaluating which diel modality (Diurnal, Nocturnal, Crepuscular) is used the most. There is no hypothesis associated to cathemerality, which is a combination of multiple modalities.
```{r 3dplot1,fig.align = "center",fig.height = 6, fig.width = 6,out.width = "6.5in"}
diel.plot(hyp=hyp.sets("Maximizing"))
```

**Traditional**

This hypothesis set uses the traditional combinations of the diel modalities of diurnal, nocturnal, crepuscular, and cathemeral. 

```{r 3dplot2,fig.align = "center",fig.height = 6, fig.width = 6,out.width = "6.5in"}

diel.plot(hyp=hyp.sets("Traditional"))
```
If left unspecified, default values are used to define the boundaries among these different hypotheses. The default value for being diurnal, nocturnal, or crepuscular is $\ge$ 0.8 probability. Cathemerality is defined as no modality has more than 0.8 probability and two or more modalities have$\ge$ 0.1 probability.

**General** 

This hypothesis set includes the Traditional definitions of diurnal, nocturnal, and crepuscular, as above, but cathemerality is defined more specifically in terms of whether two or three modalities have a high probabilty.
```{r 3dplot3,fig.align = "center",fig.height = 6, fig.width = 6,out.width = "6.5in"}
diel.plot(hyp=hyp.sets("General"))
```

**Threshold** 

This hypothesis set is based on defining each modality in terms of lower thresholds. If the thresholds are not provided, default values ared used.
```{r 3dplot4,fig.align = "center",fig.height = 6, fig.width = 6,out.width = "6.5in"}
diel.plot(hyp=hyp.sets("Threshold"))
```

**Variation**

This hypothesis set is based on defining the ranges (lower, uppper) of possible probability values. 
```{r 3dplot5,fig.align = "center",fig.height = 6, fig.width = 6,out.width = "6.5in"}
diel.plot(hyp=hyp.sets("Variation"))
```

We can also view specific hypotheses, as

```{r 3dplot6,fig.align = "center",fig.height = 8, fig.width = 8,out.width = "8.5in"}
diel.plot("D",more.points = TRUE)

```

# Simulating Data

To simulate data based on a diel hypothesis, we need define a hypothesis using its coded name. Pick a hypothesis to simulate data from and how many samples.

```{r sim1}
  set.seed(45451)
  hyp=c("CR")
  sim=sim.diel(hyp=hyp,n.sample=100)
  
  #The probability value used to simulate data
  p=sim$p
  p
  
  #The simulated data
  y=sim$y
  y

```

# Setup hypothesis set and fit models

You can setup your own model set or use the pre-defined model sets.

```{r hyp.set}
  hyp.set = c("D","CR") #manual

  hyp.set = hyp.sets("Traditional") #pre-defined
```

To fit the data to the hypothesis set, 

```{r fit}
  out = diel.fit(y,hyp.set)

#Call the model probabilities for each hypothesis in the set
  out$bf.table
```

To examine the available outputs from the fitted model object,

```{r results}
attributes(out)

?diel.fit
```
The function 'diel.fit' defaults to providing the model probabilities for each hypothesis set, but not the posterior samples of the parameters for each hypothesis. We can change this as, 

```{r results2}
  out = diel.fit(y,hyp.set,n.chains=2,post.fit = TRUE)
```

To look at convergence criteria for each hypothesis. Note that convergence can be very poor for models that do not fit the data well.
```{r convergence}
  out$gelm.diag
```

We can plot the posterior samples from the most supported model to check convergence/mixing as,
```{r postcheck,eval = TRUE,fig.height = 6, fig.width = 6}
 plot(coda::as.mcmc(out$post.samp.ms.model))
```
The posterior samples for all hypotheses are available in a list.
```{r postsamp,eval = TRUE,fig.height = 6, fig.width = 6}
 names(out$post.samp)

#For each of these list is a list of chains

length(out$post.samp[[1]])

#Here are the means of the posterior samples of all hypotheses for chain 1
lapply(out$post.samp,FUN=function(x){colMeans(x[[1]])})
```


# Plotting

Using the packages bayesplot and ggplot2, we can examine our posterior distributions along with the true probabilities values, 

```{r plot, eval = TRUE,fig.height = 4, fig.width = 6}
library(ggplot2)
library(bayesplot)

posteriors=coda::as.mcmc(out$post.samp.ms.model)

plot_title <- ggtitle("Posterior distributions",
                      "with medians and 80% intervals")
mcmc_areas(posteriors, prob = 0.8) + plot_title+ 
  geom_vline(xintercept=p[1], linetype="dashed",color = c("red"), size=1)+
  geom_vline(xintercept=p[2], linetype="dashed",color = c("purple"), size=1)+
  geom_vline(xintercept=p[3], linetype="dashed",color = c("green"), size=1)


```

Another way to examine our hypothesis is to plot the theoretical niche space for the hypothesis along with the posterior samples from the most supported model. 

```{r 3dplot 1,fig.align = "center",fig.height = 6, fig.width = 6,out.width = "6.5in"}
diel.plot(hyp=out$ms.model,more.points = TRUE,
          posteriors=out$post.samp.ms.model)
```

Or, we can plot the whole hypothesis set

```{r 3dplot 2,fig.align = "center",fig.height = 6, fig.width = 6,out.width = "6.5in"}
diel.plot(hyp=hyp.set,
          posteriors=out$post.samp.ms.model)
```

# User-specified Hypotheses

You do not need to rely on pre-set definitions of diel hypotheses. If you are interested in categorizing a diel modality based on 0.9 probability or higher, you can adjust the hypotheses using the function 'diel.ineq()' than pass this object to the plot function or model fitting function.

```{r manual example 1,fig.align = "center",fig.height = 6, fig.width = 6,out.width = "6.5in"}
  diel.setup=diel.ineq(xi.min.dom = c(0.9))
  diel.plot(hyp=hyp.sets("Traditional"),diel.setup=diel.setup)
```

If you want to separate the hypotheses and reduce the parameter space of cathmerality,

```{r manual example 2,fig.align = "center",fig.height = 6, fig.width = 6,out.width = "6.5in"}
diel.setup=diel.ineq(xi.min.dom = 0.7,separation=0.1)
diel.plot(hyp=hyp.sets("Traditional"),diel.setup=diel.setup)

```

When considering the General hypothesis set, you can adjust the lower probability value to define crepuscular, diurnal, and nocturnal, as well as adjust the definitions of Cathemeral General  vs Diurnal-Nocturnal, Crepuscular-Nocturnal, and Diurnal-Crepuscular.

```{r manual2 example 2,fig.align = "center",fig.height = 6, fig.width = 6,out.width = "6.5in"}
diel.setup=diel.ineq(xi.min.dom = c(0.9,0.05))
diel.plot(hyp=hyp.sets("General"),diel.setup=diel.setup)
```
This new hypothesis set can be used to simulate data and fit the same models by passing the object diel.setup as an attribute of the functions sim.diel, diel.fit, and diel.plot.

```{r manual example2,fig.align = "center",fig.height = 6, fig.width = 6,out.width = "6.5in"}

y=sim.diel(hyp="D.CR",n.sample = 200,diel.setup=diel.setup)$y

out = diel.fit(y,hyp.set=hyp.sets("General"),n.chains=2,post.fit = TRUE,diel.setup=diel.setup)

diel.plot(hyp=hyp.sets("General"),posteriors = out$post.samp.ms.model,diel.setup=diel.setup)
  
```
# The Unconstrained Model

If interested in comparing the constrained hypotheses to an unconstrained model, you can do that by adding it into the hypothesis set

```{r uncond,fig.align = "center",fig.height = 6, fig.width = 6,out.width = "6.5in"}
hyp.set.new=c(hyp.sets("General"),"Uncon")
out = diel.fit(y,hyp.set=hyp.set.new,n.chains=2,post.fit = FALSE,diel.setup=diel.setup)

#Compare the uncosntrained model to the rest of the models of the General hypothesis set
out$bf.table

```


# Plotting Issues in RStudio

Plotting is done using the package plotly. Plotly can have issues with RStudio. If you are using RStudio and no figures are opening then: Tools--\>Global Options--\>Advanced--\>Rendering Engine Choose "Desktop OpenGL{} and then restart RStudio.

