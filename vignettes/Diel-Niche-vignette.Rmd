---
title: "Diel-Niche-vignette"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Diel-Niche-vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  %\VignetteDepends{bayesplot,ggplot2,coda,Diel.Niche}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introducion

The $\texttt{Diel.Niche}$ package is used to evaluate how animals use the three fundamental periods of light: twilight (dawn & dusk), daytime, and nighttime. First, install and load the library

```{r package}
# Install package from GitHub via devtools.
# devtools::install_github("diel-project/Diel-Niche-Modeling",ref="main")

# Load the pacakge
  library(Diel.Niche)
```

The packages specifies many diel hypotheses, which together are defined into five hypothesis sets. The code names for the hypotheses and sets are,

```{r hyp}
what.hyp()
```

A short description of each hypothesis is available by calling,

```{r hyp2}
  what.hyp("CR")
```

To list the hypotheses of a given set,

```{r hyp3}
  hyp.sets("Traditional")

  hyp.sets("General")
```

The best way to understand each hypothesis set is by plotting hypotheses from a set. 

**Maximizing**

This hypothesis set includes three hypotheses (Crepuscular Max, Diurnal Max, and Nocturnal Max) with the objective to evaluate which time period is used most. As such, there is no hypothesis about activity across multiple time periods (i.e., cathemeral).

```{r 3dplot1,fig.align = "center",fig.height = 6, fig.width = 6,out.width = "6.5in"}
plot.diel(hyp=hyp.sets("Maximizing"))
```

**Traditional**

This hypothesis set includes four hypotheses (Crepuscular, Diurnal, Nocturnal, Traditional Cathemeral) that aim to capture the general interpretation of these hypotheses from the literature. Crepuscular, Diurnal, and Nocturnal are defined based on having at least 0.80 probability (threshold probability, $\xi_{1} = 0.80)$ in their respective diel periods (twilight, daytime, nighttime). If an animal is not mostly active in one period than it is defined as Traditional Cathemeral; this occurs when either two or three time periods are used more than $1-\xi_{1}$. The logic behind the threshold of 0.80 is that an animal uses a clear majority of time in one diel period, but is not so strict that there is not some moderate amount of activity outside of this period. While this is the default value we set for the traditional hypothesis set in $\texttt{Diel.Niche}$, it can easily be modified by a user when fitting these hypotheses to their data (see below).

```{r 3dplot2,fig.align = "center",fig.height = 6, fig.width = 6,out.width = "6.5in"}
plot.diel(hyp=hyp.sets("Traditional"))
```

**General** 

This hypothesis set includes seven hypotheses. The Diurnal, Crepuscular, and Nocturnal hypotheses are defined the same as in Traditional. The main difference is the separation of the probability space of Traditional Cathemeral into four more specific hypotheses: General Cathemeral, Crepuscular-Nocturnal, Diurnal-Nocturnal, and Diurnal-Crepuscular. The General Cathemeral hypothesis---which represents a subset of the parameter space taken by the previously mentioned Traditional Cathemeral---aims to  define when an animal uses all three diel periods (twilight, daytime, nighttime) at equal to or more than a minimum amount (i.e., $p_{\text{tw}}, p_{\text{d}}, p_{\text{n}} \leq \xi_{1}$  and $p_{\text{tw}}, p_{\text{d}}, p_{\text{n}} \geq \xi_{2}$). We defined the lower threshold probability as $\xi_{2} = 0.10$, such that we consider it important to differentiate animal activity when a diel period is used at least this much. However, if only two diel periods are used above $\xi_{2}$ then we classify this activity using one of the binomial hypotheses (Crepuscular-Nocturnal, Diurnal-Nocturnal, and Diurnal-Crepuscular).  

For an example, suppose a species is active mainly during the day with $p_{\text{d}} = 0.78$, but is also relatively active during twilight with $p_{\text{tw}} = 0.16$, and not very active at night with $p_{\text{n}} = 0.06$. We would define this activity as Diurnal-Crepuscular because $p_{\text{tw}}$ \& $p_{\text{d}} \geq \xi_{2}$, while $p_{\text{n}} < \xi_{2}$. However, if night activity was also higher than $\xi_{2}$, such that $p_{\text{d}} = 0.70$, and $ p_{\text{tw}} = p_{\text{n}} = 0.15$ then we classify this activity as General Cathemeral because a moderate to large amount of activity is occuring in all three diel periods. In summary, the Traditional hypothesis set distinguishes between unimodal and multi-modal diel activity, while the General set distinguishes among unimodal, bimodal, and trimodal activity.

```{r 3dplot3,fig.align = "center",fig.height = 6, fig.width = 6,out.width = "6.5in"}
plot.diel(hyp=hyp.sets("General"))
```


**Threshold** 

This hypothesis set is based on defining each diel period in terms of lower thresholds. If the thresholds are not provided, default values are used.
```{r 3dplot4,fig.align = "center",fig.height = 6, fig.width = 6,out.width = "6.5in"}
plot.diel(hyp=hyp.sets("Threshold"))
```

Not that where there is no colored space indicates that this set of probabilities are not considered as possible parameter values. 

**Variation**

This hypothesis set is based on defining the ranges (lower, upper) of possible probability values. 
```{r 3dplot5,fig.align = "center",fig.height = 6, fig.width = 6,out.width = "6.5in"}
plot.diel(hyp=hyp.sets("Variation"))
```

We can also view specific hypotheses, as

```{r 3dplot6,fig.align = "center",fig.height = 8, fig.width = 8,out.width = "8.5in"}
plot.diel(hyp="D",more.points = TRUE)

```

# Simulating Data

To simulate data based on a diel hypothesis, we need define a hypothesis using its coded name. Pick a hypothesis to simulate data from and how many samples.

```{r sim1}
  set.seed(45451)
  hyp=c("CR")
  sim=sim.diel(hyp=hyp,n.sample=100)
  
  #The probability value used to simulate data
  p=sim$p
  p
  
  #The simulated data
  y=sim$y
  y

```

# Setup hypothesis set and fit models

You can setup your own model set by creating a vector of coded hypothesis names or use the pre-defined model sets.

```{r hyp.set}
  hyp.set = c("D","CR") #manual

  hyp.set = hyp.sets("Traditional") #pre-defined
```

To fit the data to the hypothesis set, 

```{r fit}
  out = diel.fit(y,hyp.set)

#Call the model probabilities for each hypothesis in the set
  out$bf.table
```

To examine the available outputs from the fitted model object,

```{r results}
attributes(out)

?diel.fit
```

The function 'diel.fit' defaults to providing the model probabilities for each hypothesis set, but not the posterior samples of the parameters for each hypothesis. We can change this as, 

```{r results2}
  out = diel.fit(y,hyp.set,n.chains=2,post.fit = TRUE)
```

We can look at a convergence criteria for each hypothesis. Note that convergence can be very poor for models that do not meet the inequality constraints well.
```{r convergence}
  out$gelm.diag
```

We can plot the posterior samples from the most supported model to check convergence/mixing as,
```{r postcheck,eval = TRUE,fig.height = 6, fig.width = 6}
 plot(coda::as.mcmc(out$post.samp.ms.model))
```
The posterior samples for all hypotheses are available in a list.
```{r postsamp,eval = TRUE,fig.height = 6, fig.width = 6}
 names(out$post.samp)

#For each of these list is a list of chains

length(out$post.samp[[1]])

#Here are the means of the posterior samples of all hypotheses for chain 1
lapply(out$post.samp,FUN=function(x){colMeans(x[[1]])})
```


# Plotting

Using the packages bayesplot and ggplot2, we can examine our posterior distributions along with the true probabilities values, 

```{r plot, eval = TRUE,fig.height = 4, fig.width = 6}
library(ggplot2)
library(bayesplot)

posteriors=coda::as.mcmc(out$post.samp.ms.model)

plot_title <- ggtitle("Posterior distributions",
                      "with medians and 80% intervals")
mcmc_areas(posteriors, prob = 0.8) + plot_title+ 
  geom_vline(xintercept=p[1], linetype="dashed",color = c("red"), size=1)+
  geom_vline(xintercept=p[2], linetype="dashed",color = c("purple"), size=1)+
  geom_vline(xintercept=p[3], linetype="dashed",color = c("green"), size=1)


```

Another way to examine our hypothesis is to plot the theoretical niche space for the hypothesis along with the posterior samples from the most supported model. 

```{r 3dplot 1,fig.align = "center",fig.height = 6, fig.width = 6,out.width = "6.5in"}
plot.diel(hyp=out$ms.model,more.points = TRUE,
          posteriors=out$post.samp.ms.model)
```

Or, we can plot the whole hypothesis set

```{r 3dplot 2,fig.align = "center",fig.height = 6, fig.width = 6,out.width = "6.5in"}
plot(out)
```

# User-modified Hypotheses

You do not need to rely on pre-set definitions of diel hypotheses. If you are interested in categorizing dominant diel phenotypes based on 0.90 probability or higher, you can adjust the hypotheses using the function 'diel.ineq()' than pass this object to the plot function or model fitting function. Here, we will just define the lower bount of each diurnal, nocturnal, and crepuscular using $\xi_{1} = 0.90$

```{r manual example 1,fig.align = "center",fig.height = 6, fig.width = 6,out.width = "6.5in"}
  diel.setup=diel.ineq(xi = c(0.90))
  plot.diel(hyp=hyp.sets("Traditional"),diel.setup=diel.setup)
```

If you want to separate the hypotheses and reduce the parameter space of cathemerality,

```{r manual example 2,fig.align = "center",fig.height = 6, fig.width = 6,out.width = "6.5in"}
diel.setup=diel.ineq(xi = 0.70,separation=0.10)
plot.diel(hyp=hyp.sets("Traditional"),diel.setup=diel.setup)

```

When considering the General hypothesis set, you can adjust the lower probability value ($\xi_{1}$) to define crepuscular, diurnal, and nocturnal, as well as adjust the definitions of Cathemeral General  vs Diurnal-Nocturnal, Crepuscular-Nocturnal, and Diurnal-Crepuscular ($\xi_{2}$). To do this, set $xi$ as a vector of two probabilities,

```{r manual2 example 2,fig.align = "center",fig.height = 6, fig.width = 6,out.width = "6.5in"}
diel.setup=diel.ineq(xi = c(0.9,0.05))
plot.diel(hyp=hyp.sets("General"),diel.setup=diel.setup)
```

This new hypothesis set can be used to simulate data and fit the same models by passing the object diel.setup as an attribute of the functions sim.diel and diel.fit.

```{r manual example2,fig.align = "center",fig.height = 6, fig.width = 6,out.width = "6.5in"}

y=sim.diel(hyp="D.CR",n.sample = 200,diel.setup=diel.setup)$y

out = diel.fit(y,hyp.set=hyp.sets("General"),n.chains=2,post.fit = TRUE,diel.setup=diel.setup)

plot.diel(out)
  
```

There are additional defaults that could be changed, depending on your hypotheses of interest. 
```{r manual other}
#To see all the default inputs
  defaults=diel.ineq()
  defaults$inputs
```

For the **Variation** hypotheses, we can adjust the range of values for all hypotheses as,

```{r manual variation, fig.height = 6, fig.width = 6}

# Default
  diel.plot(hyp =hyp.sets("Variation"))

# New
  diel.plot(hyp =hyp.sets("Variation"),diel.setup=diel.ineq(e = 0.2))

  
# You can change individual hypotheses as well. Here, we are changing the range of the diurnal hypothesis only. This is not recommend. But, there is flexibility to be creative.

  diel.plot(hyp =hyp.sets("Variation"),diel.setup=diel.ineq(e.D = 0.4))
  
```

For the **Threshold** hypotheses, we can adjust the lower probability similarly as,

```{r manual threshold, fig.height = 6, fig.width = 6}
  
# Default
  diel.plot(hyp =hyp.sets("Threshold"))

# Adjusted
  diel.plot(hyp =hyp.sets("Threshold"),diel.setup=diel.ineq(xi.D = 0.6, xi.N = 0.6, xi.CR = 0.6))
  
```

# User-specified Hypotheses

Next, we will demonstrate how to include additional diel hypotheses. This requires understanding the inequality constraint setup and then coding the results as additions to the 'diel.ineq' output. Let's consider two complementary hypotheses that account for the complete parameter space among the three fundamental probabilities. Our objective is to evaluate whether an animal is highly crepuscular or not. We will define highly crepuscular as $p_{tw} \geq 0.5$. The complementing hypothesis is that the animal does not have such high crepuscular activity $p_{tw} < 0.5$.


### Hypothesis 1 Inequalities
$$
\begin{equation} 
\begin{split}
& p_{\text{tw}} \geq 0.5 \\
\end{split}
\end{equation}
$$

Next, we need to translate each inequality into the framework of $\mathbf{A} \boldsymbol{\theta} \leq \mathbf{b}$.

$$
\begin{equation} 
\begin{split}
& p_{\text{tw}} \geq 0.50 \\
& -p_{\text{tw}} \leq -0.50 \\
& (-1) \times p_{\text{tw}} + (0)\times p_{\text{d}} \leq -0.50 \\
\end{split}
\end{equation}
$$
Putting it together, we take the constants in parentheses left of the equal sign and package it into matrix $\mathbf{A}$ and take the constants on the right of the equal sign and package it into vector $\mathbf{b}$ as,

$$
\begin{equation} 
\textbf{A} = \begin{bmatrix}
-1 & 0 \\
\end{bmatrix}, \textbf{b} = \begin{bmatrix} -0.50 \\ \end{bmatrix}.
\end{equation}
$$

### Hypothesis 2 Inequalities

The complementing low activity during twilight as,

$$
\begin{equation} 
\begin{split}
& p_{\text{tw}} \leq 0.49999 \\
\end{split}
\end{equation}
$$
Following the same procedure, we find that,

$$
\begin{equation} 
\textbf{A} = \begin{bmatrix}
1 & 0 \\
\end{bmatrix}, \textbf{b} = \begin{bmatrix} 0.49999 \end{bmatrix}.
\end{equation}
$$
### Coding

Now, we need to code these hypotheses into $\texttt{Diel.Niche}$

```{r user.spec}
# First, we need to create new list elements. One for each new hypothesis, with these ordered elements in each list,

# Element 1: Name 
# Element 2:  A
# Element 3:  b
# Element 4:  func

# Note, func - this should almost always be 'bf_multinom', unless an equality statement is specified, which required function 'bf_equality'

  A <- matrix(c(-1,0),ncol = 2, byrow = TRUE)
  b <- c(-0.5)
  New1=list(Name="Highly Crepuscular",A=A,b=b,func="bf_multinom")  

  A <- matrix(c(1,0),ncol = 2, byrow = TRUE)
  b <- c(0.49999)
  New2=list(Name="Not highly Crepuscular",A=A,b=b,func="bf_multinom")  

#Second, include these new lists into diel.ineq() function as,
  
  diel.setup=diel.ineq()
  diel.setup$New1=New1
  diel.setup$New2=New2

```


We have setup our hypotheses. Now, we need to visualize them to check it's what we intended. Note that in each following, we pass our new diel.setup object to each function.


```{r user.spec.visual,fig.align = "center",fig.height = 6, fig.width = 6,out.width = "6.5in"}
plot.diel(hyp=c("New1","New2"),diel.setup = diel.setup,more.points = TRUE)
```

### Simulating and Fitting

Let's simulate data under the hypothesis that the animal is highly crepuscular.

```{r user.spec.sim}
set.seed(43243)
dat=sim.diel(n.sample=85, hyp="New1",diel.setup = diel.setup)
y=dat$y
y
```

Next, let's compare our two models

```{r user.spec.fit}
#Note, that we get a warning, which is fine
out <- diel.fit(y, hyp.set = c("New1","New2"),diel.setup=diel.setup)

#Let's look at the model probabilities, where we find the model we simulated is highly supported
out$bf.table

```

# The Unconstrained Model

If you are interested in comparing the constrained hypotheses to an unconstrained model, you can do that by adding it into the hypothesis set

```{r uncond,fig.align = "center",fig.height = 6, fig.width = 6,out.width = "6.5in"}
hyp.set.new=c(hyp.sets("General"),"Uncon")
out = diel.fit(y,hyp.set=hyp.set.new,n.chains=2,post.fit = FALSE,diel.setup=diel.setup)

#Compare the uncosntrained model to the rest of the models of the General hypothesis set
out$bf.table

```


# Data availabilty and an unequal prior

The package includes a set of available data that can be accessed as 

```{r avail.data}
head(diel.data)
?diel.data
```

Here, we will use one of the data sets to fit a model with 1) equal weight on each hypotheses and 2) prior weight that is higher on the literature definition. 

```{r prior}
# Virginia Opossum data from the Urban Wildlife Information Network
dat=diel.data[2,]

dat

y=data.frame(twilight=dat$twilight,
             day=dat$day, 
             night=dat$night)
rownames(y)=dat$Common_name

y

# Model Comparison using equal eights
out1 = diel.fit(as.matrix(y),hyp.set=hyp.sets("Traditional"),post.fit = FALSE)

# Model Comparison using 0.8 probability weigh on the nocturnal hypothesis
out2 = diel.fit(as.matrix(y),hyp.set=hyp.sets("Traditional"),post.fit = FALSE,
                prior=c(0.2/3,0.8,0.2/3,0.2/3))

# Results out1
round(out1$bf.table,digits=2)

# Results out 2
round(out2$bf.table,digits=2)
```
We see that the model weight on the nocturnal hypothesis increase because of our prior weight. 


Let's consider another case where we simulate 10 data sets with differing sample sizes to see how the prior weight affects the model weights. Specifically, we will put a high weight (0.95) on the Cathemeral Traditional hypothesis while the simulated data is from the Nocturnal hypothesis.

```{r prior2,  eval = TRUE, fig.align = "center",fig.height = 5, fig.width = 5}
set.seed(451)
n=matrix(seq(10,200, 20))
sim.dat=t(apply(n,1,FUN=function(x){sim.diel(n.sim=1, n.sample=x, hyp = "N")$y}))


prior.func=function(x,prior){out= diel.fit(t(as.matrix(x)),hyp.set=hyp.sets("Traditional"),
                                    post.fit = FALSE, print=FALSE,
                                    prior=prior)
                                    out$bf.table[,2]
}

#Equal priors
results.prior1=apply(sim.dat,1,prior=c(0.25,0.25,0.25,0.25),
                     FUN=prior.func)

# Unequal priors
results.prior2=apply(sim.dat,1,prior=c(0.05/3,0.05/3,0.05/3,0.95),
                     FUN=prior.func)

#par(mfrow=c(2,1))
matplot(t(results.prior1),type="l",lwd=3,ylab="Model Probability",xaxt="n")
axis(1,at=1:length(n),lab=n)
legend("right", legend=rownames(results.prior2),col = 1:4,lwd=3,lty = 1:4)

matplot(t(results.prior2),type="l",lwd=3,ylab="Model Probability",xaxt="n")
axis(1,at=1:length(n),lab=n)
legend("top", legend=rownames(results.prior2),col = 1:4,lwd=3,lty = 1:4)
```

The differences in the model probabilieis are entirely due to the prior weights on each hypothesis. In the second plot, the likelihood of the data is trying to overwhelm such a highly certain prior.


# Plotting Issues in RStudio

Plotting is done using the package plotly. Plotly can have issues with RStudio. If you are using RStudio and no figures are opening then: Tools--\>Global Options--\>Advanced--\>Rendering Engine Choose "Desktop OpenGL{} and then restart RStudio.

