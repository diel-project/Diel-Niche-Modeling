---
title: "Diel-Niche-vignette"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Diel-Niche-vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  %\VignetteDepends{bayesplot,ggplot2,coda,Diel.Niche}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introducion
The Diel.Niche R pacakge is setup to evaluate how animals use the three fundamental light periods of twilight (dawn & dusk), daytime, and nighttime. First, we need to install and load the library
```{r package}
#devtools::install_github("diel-project/Diel-Niche-Modeling",ref="main")

library(Diel.Niche)
```

To learn some basic information about the diel hypotheses you can call
```{r hyp}
  what.hyp()
```

If you just need to remember the names of the hypotheses you can call
```{r hyp2}
  what.hyp("?")
```

There is also a description for a specific hypothesis can also be called
```{r hyp3}
  what.hyp("D.max")
```

There are three sets of complete hypotheses, which can be viewed
```{r 3dplot1}
#Hypotheses of D.max, N.max, and CR.max, which together evaluate a hypothesis set of which diel period is used the most. This set disregards the definition of cathemrality.
diel.plot(hyp=hyp.sets("hyp.max"))

#Hypotheses of D2, N2, CR2, and C2. This is the most fundamental hypothesis set. Diurnal, Nocturnal, and Crepsucaular modalities are separated by cathemerality by having >= 0.8 probability in their diel category, respectively. When two categories are used >= 0.2 probability, it is defined as cathemeral.
diel.plot(hyp=hyp.sets("General2"))

#Hypotheses of  D.Gen, CR.Gen, N.Gen, C.Gen, DN.Gen, CRN.Gen, CRD.Gen. This set is simalar to General2, but separate cathemerality where two categories are used more than >0.1 probabilit and when three are used > 0.1 probability. 

diel.plot(hyp=hyp.sets("General3"))
```

We can also view specific hypotheses, as
```{r 3dplot2}
diel.plot("D2",more.points = TRUE)

diel.plot("N.th",more.points = TRUE)
```

# Simulate Data
To simulate data based on a diel hypothesis, we need define a hypothesis using it's coded name. Pick a hypothesis to simulate data from and how many samples.
```{r sim1}
  set.seed(45451)
  hyp=c("CR2")
  sim=sim.diel(hyp=hyp,n.sample=100)
  p=sim$p
  y=sim$y

```

# Setup hypotheses set and fit models

You can setup your own model set or use pre-defined model sets as
```{r hyp.set}
  hyp.set = c("D2","CR2") #manual
  hyp.set=hyp.sets("General2") #pre-defined
```

Lastly, we fit our model and look at the model probabilities
```{r fit}
  out = diel.fit(y,hyp.set)
  out$bf.table
```

You can discover the available outputs as

```{r results}
attributes(out)

?diel.fit
```

The default is to not return posterior samples, so to change that we can do,
```{r results2}
  out = diel.fit(y,hyp.set,n.chains=2,post.fit = TRUE)

#look at convergence
out$gelm.diag
#look at most supported models posteriors
  plot(coda::as.mcmc(out$post.samp.ms.model))
```

# Plotting

We can plot our most supported models posterior probability distribution a number of ways. Using ggplo2 and bayesplot:

```{r plot, eval = FALSE}
library(bayesplot)
library(ggplot2)

if (require(coda,ggplot2,bayesplot)) {
  posteriors=coda::as.mcmc(out$post.samp.ms.model)

plot_title <- ggtitle("Posterior distributions",
                      "with medians and 80% intervals")
mcmc_areas(posteriors, prob = 0.8) + plot_title+ 
  geom_vline(xintercept=p, linetype="dashed", 
                color = c("red","green","purple"), size=1)

}
```

Another way to examine our hypothesis to plot the theoretical niche space for the hypothesis along with the posterior samples. Or, show the whole hypothesis set

```{r 3dplot}
diel.plot(hyp=out$ms.model,more.points = TRUE,
          posteriors=out$post.samp.ms.model)


diel.plot(hyp=hyp.set,
          posteriors=out$post.samp.ms.model)

```

You do not need to rely on our definitions of diel hypotheses. If you are interested in categoriesing a diel modality based on 0.7 probabilty or higher, you could adjust the hypotheses using diel.inequaties()
```{r manual example}
diel.setup=diel.ineq(xi.min.dom = 0.7)
diel.plot(hyp=hyp.sets("General2"),diel.setup=diel.setup)

#If you want to separate the hypotheses and reduce the parameter space of cathmerality,
diel.setup=diel.ineq(xi.min.dom = 0.7,separation=0.1)
diel.plot(hyp=hyp.sets("General2"),diel.setup=diel.setup)

```
This new set could be used to simulate data from and fit the same models as, 
```{r manual example2}
y=sim.diel(hyp="CR2",n.sample = 100,diel.setup=diel.setup)$y

  out = diel.fit(y,hyp.set=hyp.sets("General2"),n.chains=2,post.fit = TRUE,diel.setup=diel.setup)

diel.plot(hyp=hyp.sets("General2"),posteriors = out$post.samp.ms.model,diel.setup=diel.setup)
  
```

If you are using RStudio and no figure is opening
Tools-->Global Options-->Advanced-->Rengering Engine
Choose "Desktop OpenGL{}
restart RStudio completely