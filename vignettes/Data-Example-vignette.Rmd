---
title: "Data-Example-vignette"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Data-Example-vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  %\VignetteDepends{bayesplot,ggplot2,coda,Diel.Niche}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introducion

We will use the Diel.Niche package to evaluate diel hypotheses of urban wildlife from Chicago, IL USA.

```{r package}
#Load the package
library(Diel.Niche)
```

Look at the data
```{r hyp}
colnames(diel.data)

dim(diel.data)

#The number of analysis units for each species
table(diel.data$scientificName)

```

Let's focus on the raccoon ('Procylon lotor').

```{r hyp2}
raccoon=  subset(diel.data, scientificName == "Procyon lotor")

y.raccoon = cbind(raccoon$twilight,raccoon$day,raccoon$night)

```

We will fit each row of data (analysis unit) to evaluate which hypothesis is most supported from the Traditional hypothesis set

```{r hyp3,fig.height = 6, fig.width = 6}
  diel.plot(hyp=hyp.sets("Traditional"))
```

# Objective 1

First, lets fit a single analysis unit and evaluate the evidence for each hypothesis and estimate the probability of activity.

```{r fit}
  out = diel.fit(y.raccoon[1,, drop=FALSE],hyp.set=hyp.sets("Traditional"),
                 post.fit = TRUE, n.chains = 3,
                 n.mcmc=5000,burnin = 1000, prints=TRUE)

#The posterior model probabilities for each hypothesis are
  out$bf.table
```

We can evaluate convergence by examining traceplots and estimate convergence statistics as,

```{r traceplots,fig.height = 8, fig.width = 6}
plot(coda::as.mcmc(out$post.samp.ms.model))
out$gelm.diag
```

To examine the posterior probabilities of activity, we can plot these as,

```{r plot, eval = TRUE,fig.height = 4, fig.width = 6}
library(ggplot2)
library(bayesplot)
library(coda)

posteriors=coda::as.mcmc(out$post.samp.ms.model)
p=apply(posteriors,2,median)
plot_title <- ggtitle("Posterior distributions",
                      "with medians and 95% intervals")
mcmc_areas(posteriors, prob = 0.95) + plot_title

```

Or, we can plot the whole hypothesis set along with the posterior samples

```{r 3dplot 2,fig.align = "center",fig.height = 6, fig.width = 6,out.width = "6.5in"}
diel.plot(hyp=hyp.sets("Traditional"),
          posteriors=out$post.samp.ms.model)
```

# Objective 2

Lets consider all the data units for the raccoon and evaluate diel hypothesis support.


```{r fit2}

multi.fit.fun = function(x){
    out = diel.fit(t(as.matrix(x)),hyp.set=hyp.sets("Traditional"),
                 post.fit = FALSE, n.chains = 1,
                 n.mcmc=5000,burnin = 1000, prints=FALSE)

  list(ms.model=out$ms.model,prob=out$bf.table)
}

out.multi=apply(y.raccoon,1,multi.fit.fun)

#The most supported hypothesis for each data unit
ms.hyps=unlist(lapply(out.multi,'[',1))

#The probabilities of the most supported hypothesis
prob.hyps=unlist(lapply(lapply(out.multi,'[',2), FUN=function(x){max(x$prob[,2])}))

```


Combine the results with the original data set:


```{r agg}
raccoon2=data.frame(raccoon,ms.hyps,prob.hyps)

# Compare hypotheses supported by season
table(raccoon2$season,raccoon2$ms.hyps)

```

For urban raccoon living in Chicago, IL USA raccoons do not appear to be diurnal or crepuscular. Interestingly, there is more nocturnal hypotheses supported in the autumn, spring, and winter while more cathemeral hypotheses are supported in the summer. 